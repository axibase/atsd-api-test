package com.axibase.tsd.api.method.trade.export

import com.axibase.tsd.api.method.entity.EntityMethod
import com.axibase.tsd.api.method.trade.TradeExportMethod.Companion.barCsv
import com.axibase.tsd.api.model.financial.Trade
import com.axibase.tsd.api.model.trade.ohlcv.*
import com.axibase.tsd.api.model.trade.ohlcv.BarsRequestType.*
import com.axibase.tsd.api.util.Mocks
import com.axibase.tsd.api.util.TestUtil
import com.axibase.tsd.api.util.Util
import org.testng.Assert
import org.testng.annotations.BeforeClass
import org.testng.annotations.DataProvider
import org.testng.annotations.Test
import java.math.BigDecimal

private val symbol = Mocks.tradeSymbol()
private val clazz = Mocks.tradeClass()
private val exchange = Mocks.tradeExchange()
private const val startDate = "2021-05-18T00:00:00Z"
private const val endDate =   "2021-05-25T00:00:00Z"
private const val timeZone = "UTC"
private val baseRequest =
    StatisticsRequest(RawTradeRequest(symbol, clazz, startDate, endDate, timeZone, null, exchange))

/**
 * This test will fail if an algorithm used to group trades into bars will be changed.
 */
class BarsTest {

    @BeforeClass
    fun insertTrades() {
        insertTrades(
            "csv/test_bars_trades.csv",
            {list -> trade(list[0], list[1], list[2])},
            1
        )
        EntityMethod.updateEntity("${symbol}_[$clazz]", mapOf("tags" to mapOf("lot" to "1")))
    }

    @Test(dataProvider = "testCases")
    fun test(testCase: TestCase) {
        val response = barCsv(testCase.type, testCase.request)
        val actualLines = response.trim().split("(\\r)?\\n".toRegex())
        val expectedLines = testCase.expectedResponseLines
        Assert.assertEquals(actualLines.size, expectedLines.size + 1, "Unexpected lines count in response.")
        for (i in expectedLines.indices) {
            checkLine(i, actualLines[i + 1], expectedLines[i])
        }
    }

    @DataProvider
    fun testCases(): Array<Array<Any>> = TestUtil.convertTo2DimArray(arrayOf(
        testCase(COUNT, dailyBarsCount = 1, bars = listOf(
            /*
                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-18T10:00:00Z,     1,     30     30    1   10    1    5  410  1410
                2021-05-18T11:00:00Z,     2,     20     40
                2021-05-18T12:00:00Z,     1,    100    100
                2021-05-18T13:00:00Z,    10,     50    500
                2021-05-18T14:00:00Z,     5,     20    100
                2021-05-18T15:00:00Z,     2,     20     40
                2021-05-18T16:00:00Z,     4,     50    200
                2021-05-18T17:00:00Z,     3,    100    300
                2021-05-18T18:00:00Z,     5,     20    100

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-19T19:00:00Z,     5,    100    500    5   10    5   10  200  1500
                2021-05-19T20:00:00Z,    10,    100   1000

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-20T01:00:00Z,     1,     20     20    1    6    1    1  240   610
                2021-05-20T02:00:00Z,     5,     10     50
                2021-05-20T03:00:00Z,     2,     10     20
                2021-05-20T04:00:00Z,     4,     30    120
                2021-05-20T05:00:00Z,     5,     20    100
                2021-05-20T06:00:00Z,     6,     10     60
                2021-05-20T07:00:00Z,     2,     50    100
                2021-05-20T08:00:00Z,     2,     20     40
                2021-05-20T10:00:00Z,     4,     10     40
                2021-05-20T11:00:00Z,     1,     50     50
                2021-05-20T12:00:00Z,     1,     10     10

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-21T10:00:00Z,     5,     10     50    5   10    1    2  440  1030
                2021-05-21T11:00:00Z,    10,     10    100
                2021-05-21T12:00:00Z,     1,    100    100
                2021-05-21T13:00:00Z,     5,     20    100
                2021-05-21T14:00:00Z,     5,     50    250
                2021-05-21T15:00:00Z,     2,    100    200
                2021-05-21T16:00:00Z,     5,     10     50
                2021-05-21T17:00:00Z,     1,    100    100
                2021-05-21T18:00:00Z,     2,     40     80

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-24T01:00:00Z,     1,     60     60    1   10    1   10  220   580
                2021-05-24T02:00:00Z,     4,     10     40
                2021-05-24T03:00:00Z,     8,     20    160
                2021-05-24T21:00:00Z,     2,     10     20
                2021-05-24T22:00:00Z,     1,    100    100
                2021-05-24T23:00:00Z,    10,     20    200
            */
            Bar("2021-05-18T10:00:00Z", 1, 10, 1, 5, 410),
            Bar("2021-05-19T19:00:00Z", 5, 10, 5, 10, 200),
            Bar("2021-05-20T01:00:00Z", 1, 6, 1, 1, 240),
            Bar("2021-05-21T10:00:00Z", 5, 10, 1, 2, 440),
            Bar("2021-05-24T01:00:00Z", 1, 10, 1, 10, 220)
        )),
        testCase(COUNT, dailyBarsCount = 2, bars = listOf(
            /*
                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-18T10:00:00Z,     1,     30     30    1   10    1    5  220  1410
                2021-05-18T11:00:00Z,     2,     20     40
                2021-05-18T12:00:00Z,     1,    100    100
                2021-05-18T13:00:00Z,    10,     50    500
                2021-05-18T14:00:00Z,     5,     20    100
                2021-05-18T15:00:00Z,     2,     20     40    2    5    2    5  190
                2021-05-18T16:00:00Z,     4,     50    200
                2021-05-18T17:00:00Z,     3,    100    300
                2021-05-18T18:00:00Z,     5,     20    100

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-19T19:00:00Z,     5,    100    500    5    5    5    5  100  1500
                2021-05-19T20:00:00Z,    10,    100   1000   10   10   10   10  100

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-20T01:00:00Z,     1,     20     20    1    6    1    6  100   610
                2021-05-20T02:00:00Z,     5,     10     50
                2021-05-20T03:00:00Z,     2,     10     20
                2021-05-20T04:00:00Z,     4,     30    120
                2021-05-20T05:00:00Z,     5,     20    100
                2021-05-20T06:00:00Z,     6,     10     60
                2021-05-20T07:00:00Z,     2,     50    100    2    4    1    1  140
                2021-05-20T08:00:00Z,     2,     20     40
                2021-05-20T10:00:00Z,     4,     10     40
                2021-05-20T11:00:00Z,     1,     50     50
                2021-05-20T12:00:00Z,     1,     10     10

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-21T10:00:00Z,     5,     10     50    5   10    1    5  190  1030
                2021-05-21T11:00:00Z,    10,     10    100
                2021-05-21T12:00:00Z,     1,    100    100
                2021-05-21T13:00:00Z,     5,     20    100
                2021-05-21T14:00:00Z,     5,     50    250
                2021-05-21T15:00:00Z,     2,    100    200    2    5    1    2  250
                2021-05-21T16:00:00Z,     5,     10     50
                2021-05-21T17:00:00Z,     1,    100    100
                2021-05-21T18:00:00Z,     2,     40     80

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-24T01:00:00Z,     1,     60     60    1    8    1    8   90   580
                2021-05-24T02:00:00Z,     4,     10     40
                2021-05-24T03:00:00Z,     8,     20    160
                2021-05-24T21:00:00Z,     2,     10     20    2   10    1   10  130
                2021-05-24T22:00:00Z,     1,    100    100
                2021-05-24T23:00:00Z,    10,     20    200
            */
            Bar("2021-05-18T10:00:00Z", 1, 10, 1, 5, 220),
            Bar("2021-05-18T15:00:00Z", 2, 5, 2, 5, 190),
            Bar("2021-05-19T19:00:00Z", 5, 5, 5, 5, 100),
            Bar("2021-05-19T20:00:00Z", 10, 10, 10, 10, 100),
            Bar("2021-05-20T01:00:00Z", 1, 6, 1, 6, 100),
            Bar("2021-05-20T07:00:00Z", 2, 4, 1, 1, 140),
            Bar("2021-05-21T10:00:00Z", 5, 10, 1, 5, 190),
            Bar("2021-05-21T15:00:00Z", 2, 5, 1, 2, 250),
            Bar("2021-05-24T01:00:00Z", 1, 8, 1, 8, 90),
            Bar("2021-05-24T21:00:00Z", 2, 10, 1, 10, 130)
        )),
        testCase(COUNT, dailyBarsCount = 3, bars = listOf(
            /*
                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-18T10:00:00Z,     1,     30     30    1    2    1    1  150  1410
                2021-05-18T11:00:00Z,     2,     20     40
                2021-05-18T12:00:00Z,     1,    100    100
                2021-05-18T13:00:00Z,    10,     50    500   10   10    2    2   90
                2021-05-18T14:00:00Z,     5,     20    100
                2021-05-18T15:00:00Z,     2,     20     40
                2021-05-18T16:00:00Z,     4,     50    200    4    5    3    5  170
                2021-05-18T17:00:00Z,     3,    100    300
                2021-05-18T18:00:00Z,     5,     20    100

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-19T19:00:00Z,     5,    100    500    5    5    5    5  100  1500
                2021-05-19T20:00:00Z,    10,    100   1000   10   10   10   10  100

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-20T01:00:00Z,     1,     20     20    1    5    1    4   70   610
                2021-05-20T02:00:00Z,     5,     10     50
                2021-05-20T03:00:00Z,     2,     10     20
                2021-05-20T04:00:00Z,     4,     30    120
                2021-05-20T05:00:00Z,     5,     20    100    5    6    2    2  100
                2021-05-20T06:00:00Z,     6,     10     60
                2021-05-20T07:00:00Z,     2,     50    100
                2021-05-20T08:00:00Z,     2,     20     40
                2021-05-20T10:00:00Z,     4,     10     40    4    4    1    1   70
                2021-05-20T11:00:00Z,     1,     50     50
                2021-05-20T12:00:00Z,     1,     10     10

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-21T10:00:00Z,     5,     10     50    5   10    1    1  120  1030
                2021-05-21T11:00:00Z,    10,     10    100
                2021-05-21T12:00:00Z,     1,    100    100
                2021-05-21T13:00:00Z,     5,     20    100    5    5    2    2  170
                2021-05-21T14:00:00Z,     5,     50    250
                2021-05-21T15:00:00Z,     2,    100    200
                2021-05-21T16:00:00Z,     5,     10     50    5    5    1    2  150
                2021-05-21T17:00:00Z,     1,    100    100
                2021-05-21T18:00:00Z,     2,     40     80

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-24T01:00:00Z,     1,     60     60    1    4    1    4   70   580
                2021-05-24T02:00:00Z,     4,     10     40
                2021-05-24T03:00:00Z,     8,     20    160    8    8    2    2   30
                2021-05-24T21:00:00Z,     2,     10     20
                2021-05-24T22:00:00Z,     1,    100    100    1   10    1   10  120
                2021-05-24T23:00:00Z,    10,     20    200
            */
            Bar("2021-05-18T10:00:00Z", 1, 2, 1, 1, 150),
            Bar("2021-05-18T13:00:00Z", 10, 10, 2, 2, 90),
            Bar("2021-05-18T16:00:00Z", 4, 5, 3, 5, 170),
            Bar("2021-05-19T19:00:00Z", 5, 5, 5, 5, 100),
            Bar("2021-05-19T20:00:00Z", 10, 10, 10, 10, 100),
            Bar("2021-05-20T01:00:00Z", 1, 5, 1, 4, 70),
            Bar("2021-05-20T05:00:00Z", 5, 6, 2, 2, 100),
            Bar("2021-05-20T10:00:00Z", 4, 4, 1, 1, 70),
            Bar("2021-05-21T10:00:00Z", 5, 10, 1, 1, 120),
            Bar("2021-05-21T13:00:00Z", 5, 5, 2, 2, 170),
            Bar("2021-05-21T16:00:00Z", 5, 5, 1, 2, 150),
            Bar("2021-05-24T01:00:00Z", 1, 4, 1, 4, 70),
            Bar("2021-05-24T03:00:00Z", 8, 8, 2, 2, 30),
            Bar("2021-05-24T22:00:00Z", 1, 10, 1, 10, 120)
        )),
        testCase(VOLUME, dailyBarsCount = 2, bars = listOf(
            /*
                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-18T10:00:00Z,     1,     30     30    1   10    1   10  200  1410
                2021-05-18T11:00:00Z,     2,     20     40
                2021-05-18T12:00:00Z,     1,    100    100
                2021-05-18T13:00:00Z,    10,     50    500
                2021-05-18T14:00:00Z,     5,     20    100    5    5    2    5  210
                2021-05-18T15:00:00Z,     2,     20     40
                2021-05-18T16:00:00Z,     4,     50    200
                2021-05-18T17:00:00Z,     3,    100    300
                2021-05-18T18:00:00Z,     5,     20    100

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-19T19:00:00Z,     5,    100    500    5    5    5    5  100  1500
                2021-05-19T20:00:00Z,    10,    100   1000   10   10   10   10  100

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-20T01:00:00Z,     1,     20     20    1    6    1    6  100   610
                2021-05-20T02:00:00Z,     5,     10     50
                2021-05-20T03:00:00Z,     2,     10     20
                2021-05-20T04:00:00Z,     4,     30    120
                2021-05-20T05:00:00Z,     5,     20    100
                2021-05-20T06:00:00Z,     6,     10     60
                2021-05-20T07:00:00Z,     2,     50    100    2    4    1    1  140
                2021-05-20T08:00:00Z,     2,     20     40
                2021-05-20T10:00:00Z,     4,     10     40
                2021-05-20T11:00:00Z,     1,     50     50
                2021-05-20T12:00:00Z,     1,     10     10

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-21T10:00:00Z,     5,     10     50    5   10    1    5  190  1030
                2021-05-21T11:00:00Z,    10,     10    100
                2021-05-21T12:00:00Z,     1,    100    100
                2021-05-21T13:00:00Z,     5,     20    100
                2021-05-21T14:00:00Z,     5,     50    250
                2021-05-21T15:00:00Z,     2,    100    200    2    5    1    2  250
                2021-05-21T16:00:00Z,     5,     10     50
                2021-05-21T17:00:00Z,     1,    100    100
                2021-05-21T18:00:00Z,     2,     40     80

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-24T01:00:00Z,     1,     60     60    1    8    1    2  100   580
                2021-05-24T02:00:00Z,     4,     10     40
                2021-05-24T03:00:00Z,     8,     20    160
                2021-05-24T21:00:00Z,     2,     10     20
                2021-05-24T22:00:00Z,     1,    100    100    1   10    1   10  120
                2021-05-24T23:00:00Z,    10,     20    200
            */
            Bar("2021-05-18T10:00:00Z", 1, 10, 1, 10, 200),
            Bar("2021-05-18T14:00:00Z", 5, 5, 2, 5, 210),
            Bar("2021-05-19T19:00:00Z", 5, 5, 5, 5, 100),
            Bar("2021-05-19T20:00:00Z", 10, 10, 10, 10, 100),
            Bar("2021-05-20T01:00:00Z", 1, 6, 1, 6, 100),
            Bar("2021-05-20T07:00:00Z", 2, 4, 1, 1, 140),
            Bar("2021-05-21T10:00:00Z", 5, 10, 1, 5, 190),
            Bar("2021-05-21T15:00:00Z", 2, 5, 1, 2, 250),
            Bar("2021-05-24T01:00:00Z", 1, 8, 1, 2, 100),
            Bar("2021-05-24T22:00:00Z", 1, 10, 1, 10, 120)
        )),
        testCase(VOLUME, dailyBarsCount = 3, bars = listOf(
            /*
                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-18T10:00:00Z,     1,     30     30    1    2    1    1  150  1410
                2021-05-18T11:00:00Z,     2,     20     40
                2021-05-18T12:00:00Z,     1,    100    100
                2021-05-18T13:00:00Z,    10,     50    500   10   10    2    4  140
                2021-05-18T14:00:00Z,     5,     20    100
                2021-05-18T15:00:00Z,     2,     20     40
                2021-05-18T16:00:00Z,     4,     50    200
                2021-05-18T17:00:00Z,     3,    100    300    3    5    3    5  120
                2021-05-18T18:00:00Z,     5,     20    100

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-19T19:00:00Z,     5,    100    500    5    5    5    5  100  1500
                2021-05-19T20:00:00Z,    10,    100   1000   10   10   10   10  100

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-20T01:00:00Z,     1,     20     20    1    5    1    5   90   610
                2021-05-20T02:00:00Z,     5,     10     50
                2021-05-20T03:00:00Z,     2,     10     20
                2021-05-20T04:00:00Z,     4,     30    120
                2021-05-20T05:00:00Z,     5,     20    100
                2021-05-20T06:00:00Z,     6,     10     60    6    6    2    2   80
                2021-05-20T07:00:00Z,     2,     50    100
                2021-05-20T08:00:00Z,     2,     20     40
                2021-05-20T10:00:00Z,     4,     10     40    4    4    1    1   70
                2021-05-20T11:00:00Z,     1,     50     50
                2021-05-20T12:00:00Z,     1,     10     10

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-21T10:00:00Z,     5,     10     50    5   10    1    5  140  1030
                2021-05-21T11:00:00Z,    10,     10    100
                2021-05-21T12:00:00Z,     1,    100    100
                2021-05-21T13:00:00Z,     5,     20    100
                2021-05-21T14:00:00Z,     5,     50    250    5    5    2    2  150
                2021-05-21T15:00:00Z,     2,    100    200
                2021-05-21T16:00:00Z,     5,     10     50    5    5    1    2  150
                2021-05-21T17:00:00Z,     1,    100    100
                2021-05-21T18:00:00Z,     2,     40     80

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-24T01:00:00Z,     1,     60     60    1    4    1    4   70   580
                2021-05-24T02:00:00Z,     4,     10     40
                2021-05-24T03:00:00Z,     8,     20    160    8    8    2    2   30
                2021-05-24T21:00:00Z,     2,     10     20
                2021-05-24T22:00:00Z,     1,    100    100    1   10    1   10  120
                2021-05-24T23:00:00Z,    10,     20    200
            */
            Bar("2021-05-18T10:00:00Z", 1, 2, 1, 1, 150),
            Bar("2021-05-18T13:00:00Z", 10, 10, 2, 4, 140),
            Bar("2021-05-18T17:00:00Z", 3, 5, 3, 5, 120),
            Bar("2021-05-19T19:00:00Z", 5, 5, 5, 5, 100),
            Bar("2021-05-19T20:00:00Z", 10, 10, 10, 10, 100),
            Bar("2021-05-20T01:00:00Z", 1, 5, 1, 5, 90),
            Bar("2021-05-20T06:00:00Z", 6, 6, 2, 2, 80),
            Bar("2021-05-20T10:00:00Z", 4, 4, 1, 1, 70),
            Bar("2021-05-21T10:00:00Z", 5, 10, 1, 5, 140),
            Bar("2021-05-21T14:00:00Z", 5, 5, 2, 2, 150),
            Bar("2021-05-21T16:00:00Z", 5, 5, 1, 2, 150),
            Bar("2021-05-24T01:00:00Z", 1, 4, 1, 4, 70),
            Bar("2021-05-24T03:00:00Z", 8, 8, 2, 2, 30),
            Bar("2021-05-24T22:00:00Z", 1, 10, 1, 10, 120)
        )),
        testCase(VOLUME, dailyBarsCount = 4, bars = listOf(
            /*
                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-18T10:00:00Z,     1,     30     30    1    2    1    1  150  1410
                2021-05-18T11:00:00Z,     2,     20     40
                2021-05-18T12:00:00Z,     1,    100    100
                2021-05-18T13:00:00Z,    10,     50    500   10   10    2    2   90
                2021-05-18T14:00:00Z,     5,     20    100
                2021-05-18T15:00:00Z,     2,     20     40
                2021-05-18T16:00:00Z,     4,     50    200    4    4    4    4   50
                2021-05-18T17:00:00Z,     3,    100    300    3    5    3    5  120
                2021-05-18T18:00:00Z,     5,     20    100

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-19T19:00:00Z,     5,    100    500    5    5    5    5  100  1500
                2021-05-19T20:00:00Z,    10,    100   1000   10   10   10   10  100

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-20T01:00:00Z,     1,     20     20    1    5    1    4   70   610
                2021-05-20T02:00:00Z,     5,     10     50
                2021-05-20T03:00:00Z,     2,     10     20
                2021-05-20T04:00:00Z,     4,     30    120
                2021-05-20T05:00:00Z,     5,     20    100    5    6    2    2   80
                2021-05-20T06:00:00Z,     6,     10     60
                2021-05-20T07:00:00Z,     2,     50    100
                2021-05-20T08:00:00Z,     2,     20     40    2    4    2    4   30
                2021-05-20T10:00:00Z,     4,     10     40
                2021-05-20T11:00:00Z,     1,     50     50    1    1    1    1   60
                2021-05-20T12:00:00Z,     1,     10     10

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-21T10:00:00Z,     5,     10     50    5   10    1    1  120  1030
                2021-05-21T11:00:00Z,    10,     10    100
                2021-05-21T12:00:00Z,     1,    100    100
                2021-05-21T13:00:00Z,     5,     20    100    5    5    5    5   70
                2021-05-21T14:00:00Z,     5,     50    250
                2021-05-21T15:00:00Z,     2,    100    200    2    5    2    5  110
                2021-05-21T16:00:00Z,     5,     10     50
                2021-05-21T17:00:00Z,     1,    100    100    1    2    1    2  140
                2021-05-21T18:00:00Z,     2,     40     80

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-24T01:00:00Z,     1,     60     60    1    1    1    1   60   580
                2021-05-24T02:00:00Z,     4,     10     40    4    8    2    2   40
                2021-05-24T03:00:00Z,     8,     20    160
                2021-05-24T21:00:00Z,     2,     10     20
                2021-05-24T22:00:00Z,     1,    100    100    1    1    1    1  100
                2021-05-24T23:00:00Z,    10,     20    200   10   10   10   10   20
            */
            Bar("2021-05-18T10:00:00Z", 1, 2, 1, 1, 150),
            Bar("2021-05-18T13:00:00Z", 10, 10, 2, 2, 90),
            Bar("2021-05-18T16:00:00Z", 4, 4, 4, 4, 50),
            Bar("2021-05-18T17:00:00Z", 3, 5, 3, 5, 120),
            Bar("2021-05-19T19:00:00Z", 5, 5, 5, 5, 100),
            Bar("2021-05-19T20:00:00Z", 10, 10, 10, 10, 100),
            Bar("2021-05-20T01:00:00Z", 1, 5, 1, 4, 70),
            Bar("2021-05-20T05:00:00Z", 5, 6, 2, 2, 80),
            Bar("2021-05-20T08:00:00Z", 2, 4, 2, 4, 30),
            Bar("2021-05-20T11:00:00Z", 1, 1, 1, 1, 60),
            Bar("2021-05-21T10:00:00Z", 5, 10, 1, 1, 120),
            Bar("2021-05-21T13:00:00Z", 5, 5, 5, 5, 70),
            Bar("2021-05-21T15:00:00Z", 2, 5, 2, 5, 110),
            Bar("2021-05-21T17:00:00Z", 1, 2, 1, 2, 140),
            Bar("2021-05-24T01:00:00Z", 1, 1, 1, 1, 60),
            Bar("2021-05-24T02:00:00Z", 4, 8, 2, 2, 40),
            Bar("2021-05-24T22:00:00Z", 1, 1, 1, 1, 100),
            Bar("2021-05-24T23:00:00Z", 10, 10, 10, 10, 20),
            )),
        testCase(AMOUNT, dailyBarsCount = 3, bars = listOf(
            /*
                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-18T10:00:00Z,     1,     30     30    1   10    1   10  200  1410
                2021-05-18T11:00:00Z,     2,     20     40
                2021-05-18T12:00:00Z,     1,    100    100
                2021-05-18T13:00:00Z,    10,     50    500
                2021-05-18T14:00:00Z,     5,     20    100    5    5    2    4   90
                2021-05-18T15:00:00Z,     2,     20     40
                2021-05-18T16:00:00Z,     4,     50    200
                2021-05-18T17:00:00Z,     3,    100    300    3    5    3    5  120
                2021-05-18T18:00:00Z,     5,     20    100

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-19T19:00:00Z,     5,    100    500    5    5    5    5  100  1500
                2021-05-19T20:00:00Z,    10,    100   1000   10   10   10   10  100

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-20T01:00:00Z,     1,     20     20    1    5    1    4   70   610
                2021-05-20T02:00:00Z,     5,     10     50
                2021-05-20T03:00:00Z,     2,     10     20
                2021-05-20T04:00:00Z,     4,     30    120
                2021-05-20T05:00:00Z,     5,     20    100    5    6    5    6   30
                2021-05-20T06:00:00Z,     6,     10     60
                2021-05-20T07:00:00Z,     2,     50    100    2    4    1    1  140
                2021-05-20T08:00:00Z,     2,     20     40
                2021-05-20T10:00:00Z,     4,     10     40
                2021-05-20T11:00:00Z,     1,     50     50
                2021-05-20T12:00:00Z,     1,     10     10

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-21T10:00:00Z,     5,     10     50    5   10    1    5  140  1030
                2021-05-21T11:00:00Z,    10,     10    100
                2021-05-21T12:00:00Z,     1,    100    100
                2021-05-21T13:00:00Z,     5,     20    100
                2021-05-21T14:00:00Z,     5,     50    250    5    5    5    5   50
                2021-05-21T15:00:00Z,     2,    100    200    2    5    1    2  250
                2021-05-21T16:00:00Z,     5,     10     50
                2021-05-21T17:00:00Z,     1,    100    100
                2021-05-21T18:00:00Z,     2,     40     80

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-24T01:00:00Z,     1,     60     60    1    8    1    8   90   580
                2021-05-24T02:00:00Z,     4,     10     40
                2021-05-24T03:00:00Z,     8,     20    160
                2021-05-24T21:00:00Z,     2,     10     20    2    2    1    1  110
                2021-05-24T22:00:00Z,     1,    100    100
                2021-05-24T23:00:00Z,    10,     20    200   10   10   10   10   20
            */
            Bar("2021-05-18T10:00:00Z", 1, 10, 1, 10, 200),
            Bar("2021-05-18T14:00:00Z", 5, 5, 2, 4, 90),
            Bar("2021-05-18T17:00:00Z", 3, 5, 3, 5, 120),
            Bar("2021-05-19T19:00:00Z", 5, 5, 5, 5, 100),
            Bar("2021-05-19T20:00:00Z", 10, 10, 10, 10, 100),
            Bar("2021-05-20T01:00:00Z", 1, 5, 1, 4, 70),
            Bar("2021-05-20T05:00:00Z", 5, 6, 5, 6, 30),
            Bar("2021-05-20T07:00:00Z", 2, 4, 1, 1, 140),
            Bar("2021-05-21T10:00:00Z", 5, 10, 1, 5, 140),
            Bar("2021-05-21T14:00:00Z", 5, 5, 5, 5, 50),
            Bar("2021-05-21T15:00:00Z", 2, 5, 1, 2, 250),
            Bar("2021-05-24T01:00:00Z", 1, 8, 1, 8, 90),
            Bar("2021-05-24T21:00:00Z", 2, 2, 1, 1, 110),
            Bar("2021-05-24T23:00:00Z", 10, 10, 10, 10, 20)
        )),
        testCase(AMOUNT, barSize = BigDecimal("330.5"), bars = listOf(
            /*
                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-18T10:00:00Z,     1,     30     30    1   10    1   10  200  1410
                2021-05-18T11:00:00Z,     2,     20     40
                2021-05-18T12:00:00Z,     1,    100    100
                2021-05-18T13:00:00Z,    10,     50    500
                2021-05-18T14:00:00Z,     5,     20    100    5    5    2    4   90
                2021-05-18T15:00:00Z,     2,     20     40
                2021-05-18T16:00:00Z,     4,     50    200
                2021-05-18T17:00:00Z,     3,    100    300    3    5    3    5  120
                2021-05-18T18:00:00Z,     5,     20    100

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-19T19:00:00Z,     5,    100    500    5    5    5    5  100  1500
                2021-05-19T20:00:00Z,    10,    100   1000   10   10   10   10  100

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-20T01:00:00Z,     1,     20     20    1    6    1    6  100   610
                2021-05-20T02:00:00Z,     5,     10     50
                2021-05-20T03:00:00Z,     2,     10     20
                2021-05-20T04:00:00Z,     4,     30    120
                2021-05-20T05:00:00Z,     5,     20    100
                2021-05-20T06:00:00Z,     6,     10     60
                2021-05-20T07:00:00Z,     2,     50    100    2    4    1    1  140
                2021-05-20T08:00:00Z,     2,     20     40
                2021-05-20T10:00:00Z,     4,     10     40
                2021-05-20T11:00:00Z,     1,     50     50
                2021-05-20T12:00:00Z,     1,     10     10

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-21T10:00:00Z,     5,     10     50    5   10    1    5  140  1030
                2021-05-21T11:00:00Z,    10,     10    100
                2021-05-21T12:00:00Z,     1,    100    100
                2021-05-21T13:00:00Z,     5,     20    100
                2021-05-21T14:00:00Z,     5,     50    250    5    5    2    2  150
                2021-05-21T15:00:00Z,     2,    100    200
                2021-05-21T16:00:00Z,     5,     10     50    5    5    1    2  150
                2021-05-21T17:00:00Z,     1,    100    100
                2021-05-21T18:00:00Z,     2,     40     80

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap
                2021-05-24T01:00:00Z,     1,     60     60    1    8    1    1  200   580
                2021-05-24T02:00:00Z,     4,     10     40
                2021-05-24T03:00:00Z,     8,     20    160
                2021-05-24T21:00:00Z,     2,     10     20
                2021-05-24T22:00:00Z,     1,    100    100
                2021-05-24T23:00:00Z,    10,     20    200   10   10   10   10   20
            */
            Bar("2021-05-18T10:00:00Z", 1, 10, 1, 10, 200),
            Bar("2021-05-18T14:00:00Z", 5, 5, 2, 4, 90),
            Bar("2021-05-18T17:00:00Z", 3, 5, 3, 5, 120),
            Bar("2021-05-19T19:00:00Z", 5, 5, 5, 5, 100),
            Bar("2021-05-19T20:00:00Z", 10, 10, 10, 10, 100),
            Bar("2021-05-20T01:00:00Z", 1, 6, 1, 6, 100),
            Bar("2021-05-20T07:00:00Z", 2, 4, 1, 1, 140),
            Bar("2021-05-21T10:00:00Z", 5, 10, 1, 5, 140),
            Bar("2021-05-21T14:00:00Z", 5, 5, 2, 2, 150),
            Bar("2021-05-21T16:00:00Z", 5, 5, 1, 2, 150),
            Bar("2021-05-24T01:00:00Z", 1, 8, 1, 1, 200),
            Bar("2021-05-24T23:00:00Z", 10, 10, 10, 10, 20)
        )),
        testCase(TIME, period = "6 HOUR", bars = listOf(
            /*
                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap  hour
                2021-05-18T10:00:00Z,     1,     30     30    1    2    1    2   50  1410    06
                2021-05-18T11:00:00Z,     2,     20     40
                2021-05-18T12:00:00Z,     1,    100    100    1    10   1    3  340          12
                2021-05-18T13:00:00Z,    10,     50    500
                2021-05-18T14:00:00Z,     5,     20    100
                2021-05-18T15:00:00Z,     2,     20     40
                2021-05-18T16:00:00Z,     4,     50    200
                2021-05-18T17:00:00Z,     3,    100    300
                2021-05-18T18:00:00Z,     5,     20    100    5    5    5    5   20          18

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap  hour
                2021-05-19T19:00:00Z,     5,    100    500    5   10    5   10  200  1500    18
                2021-05-19T20:00:00Z,    10,    100   1000

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap  hour
                2021-05-20T01:00:00Z,     1,     20     20    1    5    1    5   90   610    00
                2021-05-20T02:00:00Z,     5,     10     50
                2021-05-20T03:00:00Z,     2,     10     20
                2021-05-20T04:00:00Z,     4,     30    120
                2021-05-20T05:00:00Z,     5,     20    100
                2021-05-20T06:00:00Z,     6,     10     60    6    6    1    1  140          06
                2021-05-20T07:00:00Z,     2,     50    100
                2021-05-20T08:00:00Z,     2,     20     40
                2021-05-20T10:00:00Z,     4,     10     40
                2021-05-20T11:00:00Z,     1,     50     50
                2021-05-20T12:00:00Z,     1,     10     10    1    1    1    1   10          12

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap  hour
                2021-05-21T10:00:00Z,     5,     10     50    5   10    5   10   20  1030    06
                2021-05-21T11:00:00Z,    10,     10    100
                2021-05-21T12:00:00Z,     1,    100    100    1    5    1    1  380          12
                2021-05-21T13:00:00Z,     5,     20    100
                2021-05-21T14:00:00Z,     5,     50    250
                2021-05-21T15:00:00Z,     2,    100    200
                2021-05-21T16:00:00Z,     5,     10     50
                2021-05-21T17:00:00Z,     1,    100    100
                2021-05-21T18:00:00Z,     2,     40     80    2    2    2    2   40          18

                Time,                 Price, Volume    Cap    O    H    L    C    V   Cap  hour
                2021-05-24T01:00:00Z,     1,     60     60    1    8    1    8   90   580    00
                2021-05-24T02:00:00Z,     4,     10     40
                2021-05-24T03:00:00Z,     8,     20    160
                2021-05-24T21:00:00Z,     2,     10     20    2   10    1   10  130          18
                2021-05-24T22:00:00Z,     1,    100    100
                2021-05-24T23:00:00Z,    10,     20    200
            */
            Bar("2021-05-18T06:00:00Z", 1, 2, 1, 2, 50),
            Bar("2021-05-18T12:00:00Z", 1, 10, 1, 3, 340),
            Bar("2021-05-18T18:00:00Z", 5, 5, 5, 5, 20),

            Bar("2021-05-19T18:00:00Z", 5, 10, 5, 10, 200),

            Bar("2021-05-20T00:00:00Z", 1, 5, 1, 5, 90),
            Bar("2021-05-20T06:00:00Z", 6, 6, 1, 1, 140),
            Bar("2021-05-20T12:00:00Z", 1, 1, 1, 1, 10),

            Bar("2021-05-21T06:00:00Z", 5, 10, 5, 10, 20),
            Bar("2021-05-21T12:00:00Z", 1, 5, 1, 1, 380),
            Bar("2021-05-21T18:00:00Z", 2, 2, 2, 2, 40),

            Bar("2021-05-24T00:00:00Z", 1, 8, 1, 8, 90),
            Bar("2021-05-24T18:00:00Z", 2, 10, 1, 10, 130)
        ))
        ))

    private fun testCase(type: BarsRequestType,
                         dailyBarsCount: Int? = null,
                         barSize: BigDecimal? = null,
                         period: String? = null,
                         bars: List<Bar>): TestCase {
        val request: BarsRequest = when {
            dailyBarsCount != null -> BarsCountRequest(baseRequest, dailyBarsCount)
            barSize != null -> BarsSizeRequest(baseRequest, barSize)
            period != null -> BarsTimeRequest(baseRequest, period)
            else -> throw IllegalArgumentException("Either 'dailyBarsCount' or 'barSize' required.")
        }
        val responseLines = bars.map { it.toResponseLine() }.toList()
        return TestCase(type, request, responseLines)
    }

    private fun trade(date: String, price: String, volume: String): Trade {
        val trade = Trade(exchange, clazz, symbol, Mocks.tradeNum(), date, BigDecimal(price), volume.toLong())
        trade.side = Trade.Side.BUY
        return trade
    }

    class TestCase(
        val type: BarsRequestType,
        val request: BarsRequest,
        val expectedResponseLines: List<ResponseLine>
    )

    data class Bar(
        val isoTime: String,
        val open: Long,
        val high: Long,
        val low: Long,
        val close: Long,
        val volume: Int
    ) {
        fun toResponseLine(): ResponseLine = ResponseLine(
            Util.getUnixTime(isoTime),
            BigDecimal.valueOf(open),
            BigDecimal.valueOf(high),
            BigDecimal.valueOf(low),
            BigDecimal.valueOf(close),
            volume)
    }
}